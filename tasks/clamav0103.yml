---

- block:
    - name: Setup ClamAV database update config
      template:
        src: freshclam.conf.j2
        dest: /etc/freshclam.conf
        owner: root
        group: root
        mode: 0644
        backup: yes
      register: clamav_setup_freshclam_result

    - name: Setup ClamAV database update service log file
      file:
        path: "{{ clamav_freshclam_log }}"
        mode: 0660
        state: touch
        owner: "{{ clamav_user }}"
        group: "{{ clamav_freshclam_database_owner }}"
      when: clamav_freshclam_log is defined

    - name: Update ClamAV database
      command: /usr/bin/freshclam
      changed_when: yes
      when: clamav_setup_freshclam_result is changed

    - name: Start ClamAV scan service
      systemd:
        name: clamav-freshclam
        enabled: yes
        state: started
        no_block: yes

    # resolve some problems with file permissions
    - name: check database file permissions
      file:
        path: "/var/lib/clamav/{{ item }}"
        mode: 0644
        state: touch
      loop:
        - bytecode.cvd
        - daily.cld
        - main.cvd

    - name: view permissions
      command: "ls -la /var/lib/clamav"
      register: ls_output

    - debug:
        msg: "{{ ls_output.stdout_lines }}"

    - name: Setup ClamAV scan service unit
      template:
        src: scan-clamav0103.service.j2
        dest: /usr/lib/systemd/system/clamd-scan.service
#        owner: root
#        group: root
        mode: 0644
        backup: yes

    - name: Setup ClamAV scan configuration file
      template:
        src: scan.conf.j2
        dest: /etc/clamd.d/scan.conf
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: Start ClamAV scan service
      systemd:
        name: clamd-scan.service
        enabled: yes
        state: started
        no_block: yes
