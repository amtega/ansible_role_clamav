---

- block:
    - name: Setup ClamAV database update config
      template:
        src: freshclam.conf.j2
        dest: /etc/freshclam.conf
        owner: root
        group: root
        mode: 0644
        backup: yes
      register: clamav_setup_freshclam_result

    - name: Setup ClamAV database update service log file
      file:
        path: "{{ clamav_freshclam_log }}"
        mode: 0660
        state: touch
        owner: "{{ clamav_user }}"
        group: "{{ clamav_freshclam_database_owner }}"
        changed_when: false
      when: clamav_freshclam_log is defined

    - name: Setup ClamAV database update service unit
      template:
        src: freshclam.service.j2
        dest: /usr/lib/systemd/system/freshclam.service
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: Setup ClamAV scan configuration file
      template:
        src: scan.conf.j2
        dest: /etc/clamd.d/scan.conf
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: Setup ClamAV service log file
      file:
        path: "{{ clamav_log_file }}"
        mode: 0660
        state: touch
        owner: "{{ clamav_user }}"
        group: root
        changed_when: false
      when: clamav_log_file is defined

    - name: Setup ClamAV logrotate file
      template:
        src: logrotate_clamav.j2
        dest: /etc/logrotate.d/clamav-scan
        mode: 0640
      when:
        - clamav_log_file is defined
        - clamav_logrotate_d | bool

    - name: Remove ClamAV logrotate file
      file:
        path: /etc/logrotate.d/clamav-scan
        state: absent
      when: not clamav_logrotate_d | bool

    - name: Setup ClamAV scan service unit
      template:
        src: scan.service.j2
        dest: /usr/lib/systemd/system/clamd@scan.service
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: Update ClamAV database
      block:
        - name: For safety remove CVD files
          file:
            path: "{{ item }}"
            state: absent
          with_fileglob:
            - "/var/lib/clamav/*.cvd"

        - name: Execute update command
          command: /usr/bin/freshclam
          changed_when: false

        - name: For safety change database permissions
          file:
            path: "{{ item }}"
            #mode: 0660
            group: "{{ grp_clamav_local_socket_group }}"
          with_fileglob:
            - "/var/lib/clamav/*.cvd"
      when: clamav_setup_freshclam_result is changed

    - name: Start ClamAV database update service
      systemd:
        name: freshclam
        enabled: yes
        state: started

    - name: Start ClamAV scan service
      systemd:
        name: clamd@scan.service
        enabled: yes
        state: started
        no_block: yes
